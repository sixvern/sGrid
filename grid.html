<html>
<head>
<title>grid test</title>
<link href="css/sGrid.css" media="all" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
<script type="text/javascript">
(function ( $ ) {
	/**
	 * Grid Header
	 */
	$.fn.svGridHeader = function(opts) {
		
		/**
		 * Add Current Elements to Grid
		 */
		opts.gridObj.append(this);
		/**
		 * Add Current prototype to Grid
		 */
		opts.grid.gridHeader = this;
		
		/**
		 * JQuery Object for future use
		 */
		var headerObj = $(this);
		headerObj.attr( 'id', 'gridHeaderDiv' );
		headerObj.addClass( 'gridHeaderDiv' );
		//headerTabObj.id='gridHeaderDiv';
		this.getObject = function(){
			return headerObj;
		};
		
		var headerTabObj = document.createElement("table");
		headerTabObj.className = 'gridHeaderDiv';
		headerObj.append(headerTabObj);
		
		this.init = function(){
			this.refresh();
		};
		
		this.refresh = function(){
			var headerData = opts.headerData;
			var htmlSrc;
			
			htmlSrc = ""
				+ "<table class='gridHeader'>"
			;
			
			for( var hi = 0; headerData != null && hi < headerData.length; hi++ ){
				htmlSrc += ""
					+ "<tr>"
				;
				for( var hj = 0; headerData[ hi ] != null && hj < headerData[ hi ].length; hj++ ){
					htmlSrc += ""
						+ "<td"
					;
					if( headerData[ hi ][ hj ].colKey != null && headerData[ hi ][ hj ].colKey != '' ){
						htmlSrc += ""
							+ " id='" + opts.id + "_GridHCol_" + headerData[ hi ][ hj ].colKey + "'"
						;
					}
					htmlSrc += ""
						+ " colSpan='" + headerData[ hi ][ hj ].colSpan + "'"
						+ " rowSpan='" + headerData[ hi ][ hj ].rowSpan + "'"
						+ ">"
						+ headerData[ hi ][ hj ].colTitle
						+ "</td>"
					;
				}
				htmlSrc += ""
					+ "</tr>"
				;
			}
			htmlSrc += ""
				+ "</table>"
			;
			
			headerObj.html( htmlSrc );
		};
		
		this.init();
		
		return this.each(function(){$this = $(this);});
		
	};
	
	/**
	 * Grid Row
	 */
	$.fn.svGridRow = function(opts) {
		
		this.init();
		
		return this.each(function(){$this = $(this);});
		
	};
	
	/**
	 * Grid Contents
	 */
	$.fn.svGridContents = function(opts) {
		
		/**
		 * Add Current Elements to Grid
		 */
		opts.gridObj.append(this);
		/**
		 * Add Current prototype to Grid
		 */
		opts.grid.gridContents = this;
		
		/**
		 * JQuery Object for future use
		 */
		var contentsObj = $(this);
		contentsObj.attr( 'id', 'gridContentsDiv' );
		contentsObj.addClass( 'gridContentsDiv' );
		this.getObject = function(){
			return contentsObj;
		};
		
		this.init = function(){
			/**
			 * Syncronized Scroll X
			 */
			contentsObj.on('scroll', function ( e ) {
			    e.preventDefault();
			    opts.grid.gridHeader.getObject().scrollLeft(contentsObj.scrollLeft());
			    return true;
			});
			this.refresh();
		};
		
		this.refresh = function(){
			
			var rawData = opts.rawData;
			var colData = opts.colData;
			
			var htmlSrc;
			
			htmlSrc = ""
				+ "<table class='gridContents'>"
			;
			htmlSrc += ""
				+ "<colGroup>"
			;
			for( var cj = 0; colData != null && cj < colData.length; cj++ ){
				htmlSrc += ""
					+ "<col"
					+ " id='" + opts.id + "_GridCol_" + colData[ cj ].colKey + "''"
					+ "/>"
				;
			}
			htmlSrc += ""
				+ "</colGroup>"
			;
			
			for( var ci = 0; rawData != null && ci < rawData.length; ci++ ){
				htmlSrc += ""
					+ "<tr id='" + opts.id + "_GridRow'>"
				;
 				for( var cj = 0; colData != null && cj < colData.length; cj++ ){
					htmlSrc += ""
						+ "<td"
						+ " id='" + opts.id + "_GridDataCol_" + colData[ cj ].colKey + "'"
						+ ">"
						+ rawData[ ci ][ colData[ cj ].colKey ]
						+ "</td>"
					;
 				}
				htmlSrc += ""
					+ "</tr>"
				;
			}
			htmlSrc += ""
				+ "</table>"
			;
			
			contentsObj.html( htmlSrc );
			
			/**
			 * Grid Width Synchronize
			 */
			opts.grid.syncSize();
			
		};
		
		this.init();
		
		return this.each(function(){$this = $(this);});
		
	};
	
	/**
	 * Grid Main
	 */
	$.fn.svGrid = function(options) {
		var defaults = {
			yScrollWidth:15
		};
		
		var opts = $.extend({}, defaults, options);
		
		this.gridObj = $(this);
		
		if( opts.id == null ){
			opts.id = this.gridObj.attr( 'id' );
		}
		
		/**
		 * Set Grid into Options
		 */
		opts.gridObj = this.gridObj;
		/**
		 * Set Prototype into Options
		 */
		opts.grid = this;
		
		this.gridObj.empty();
		
		/**
		 * Grid Init
		 */
		this.init = function(){
		
			if( opts.headerData == null ){
				var headerData = [];
				var colData = opts.colData;
				for( var hi = 0; colData != null && hi < colData.length; hi++ ){
					headerData.push( 
						{ 
							  colKey   : colData[ hi ].colKey
							, colTitle : colData[ hi ].colTitle
							, colSpan  : 1
							, rowSpan  : 1
						}
					);
				}
				opts.headerData = [headerData];
			}
			
			/**
			 * Grid Header Init
			 */
			$(document.createElement("div")).svGridHeader( opts );
			/**
			 * Grid Contents Init
			 */
			$(document.createElement("div")).svGridContents( opts );
			
		}
		
		this.getRawData = function(){
			return opts.rawData;
		};
		
		this.setRawData = function( pData ){
			opts.rawData = pData;
			this.gridContents.refresh();
		};
		
		this.setColumns = function( pColProp, pHeaderProp ){
			
			opts.colData = pColProp;
			opts.headerData = pHeaderProp;
			
			this.gridHeader.refresh();
			this.gridContents.refresh();
		}
		
		this.syncSize = function(){
			var colData = opts.colData;
			var cKey;
			var hColObj;
			var cColObj;
			var cWidth;
			
			var headerDivObj = this.gridHeader.getObject();
			var contDivObj = this.gridContents.getObject();
			
			contDivObj.height( this.gridObj.height() - headerDivObj.height() );
			headerDivObj.find( '.gridHeader' ).width( contDivObj.find( '.gridContents' ).width() );
			
			if( 
				   contDivObj.height() < contDivObj[ 0 ].scrollHeight 
				&& contDivObj.width() < contDivObj[ 0 ].scrollWidth
			){
				headerDivObj.width( this.gridObj.width() - opts.yScrollWidth );
			}else{
				headerDivObj.width( this.gridObj.width() );
			}
			
			for( var swi = 0; swi < colData.length; swi++ ){
				cKey = colData[ swi ].colKey;
				hColObj = this.gridHeader.getObject().find( '#' + opts.id + '_GridHCol_' + cKey );
				cColObj = this.gridContents.getObject().find( '#' + opts.id + '_GridCol_' + cKey );
				cWidth = Math.max(
					  hColObj.width()
					, this.gridContents.getObject().find( '#' + opts.id + '_GridDataCol_' + cKey ).width()
				);
				hColObj.width( cWidth );
				cColObj.width( cWidth );
			}
			
		}
		
		this.init();
		
		return this.each(function(){$this = $(this);});
		
	};
	
})(jQuery);

$(document).ready(function() {
	curGrid = $("#test").svGrid({
		  id:"test"
		, yScrollWidth:17
		, colData:[
			  { colKey : "ID"   , colTitle : "ID"     }
			, { colKey : "NAME" , colTitle : "Name"   }
			, { colKey : "INFO1", colTitle : "Info 1" }
			, { colKey : "INFO2", colTitle : "Info 2" }
			, { colKey : "INFO3", colTitle : "Info 3" }
			, { colKey : "INFO4", colTitle : "Info 4" }
			, { colKey : "INFO5", colTitle : "Info 5" }
			, { colKey : "ETC"  , colTitle : "ETC"    }
		]
		, headerData:[
			[
				  //{ colTitle : "Info" , colSpan : 2, rowSpan : 1 }
				  { colTitle : "ID"   , colKey : "ID"   , colSpan : 1, rowSpan : 2 }
				, { colTitle : "Name" , colKey : "NAME" , colSpan : 1, rowSpan : 2 }
				, { colTitle : "Data" , colSpan : 6, rowSpan : 1 }
				
			]
			, [
				  { colTitle : "Info 1", colKey : "INFO1", colSpan : 1, rowSpan : 1 }
				, { colTitle : "Info 2", colKey : "INFO2", colSpan : 1, rowSpan : 1 }
				, { colTitle : "Info 3", colKey : "INFO3", colSpan : 1, rowSpan : 1 }
				, { colTitle : "Info 4", colKey : "INFO4", colSpan : 1, rowSpan : 1 }
				, { colTitle : "Info 5", colKey : "INFO5", colSpan : 1, rowSpan : 1 }
				, { colTitle : "Etc"   , colKey : "ETC"  , colSpan : 1, rowSpan : 1 }
			]
		]
	});
	setData();
});

function setColumns( pInfoLen ){
	
	if( pInfoLen == null ){
		pInfoLen = 5;
	}else{
		pInfoLen = Math.min( pInfoLen, 5 );
	}
	
	var colData = [];
	var headerData = [];

	
	colData.push({ colKey : "ID"   , colTitle : "ID"     });
	colData.push({ colKey : "NAME" , colTitle : "Name"   });
	for( var li = 1; li <= pInfoLen; li ++ ){
		colData.push({ colKey : "INFO" + li, colTitle : "Info " + li });
	}
	colData.push({ colKey : "ETC"  , colTitle : "ETC"    });
	
	headerData.push(
		[
			  { colTitle : "Info" , colSpan : 2, rowSpan : 1 }
			, { colTitle : "Data" , colSpan : pInfoLen+1, rowSpan : 1 }
		]
	);
	headerData.push([
		  { colTitle : "ID"    ,colKey : "ID"   , colSpan : 1, rowSpan : 1 }
		, { colTitle : "Name"  ,colKey : "NAME" , colSpan : 1, rowSpan : 1 }
	]);
	for( var li = 1; li <= pInfoLen; li ++ ){
		headerData[ 1 ].push({ colTitle : "Info " + li,colKey : "INFO" + li, colSpan : 1, rowSpan : 1 });
	}
	headerData[ 1 ].push({ colTitle : "Etc"   ,colKey : "ETC"  , colSpan : 1, rowSpan : 1 });
	
	
	curGrid.setColumns( colData,headerData );
	
}

function setData( pDataLen ){
	if( pDataLen == null ){
		pDataLen = 20;
	} 
	var addData = new Array();
	for( var i = 0; i < pDataLen; i ++ ){
		addData.push(
			{
				  ID:i
				, NAME:'name[' + i + ']'
				, INFO1:'INFO1[' + i + ']'
				, INFO2:'INFO2[' + i + ']'
				, INFO3:'INFO3[' + i + ']'
				, INFO4:'INFO4[' + i + ']'
				, INFO5:'INFO5[' + i + ']'
				, ETC:'ETC[' + i + ']'
			}
		);
	}
	
	curGrid.setRawData( addData );
}


</script>
</head>
<body>
	<div id="test" class="svGrid" style="width:100%;height:300px;">
		test
	</div>
</body>
</html>
